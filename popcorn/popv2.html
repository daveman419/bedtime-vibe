<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Popcorn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.20.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            position: relative;
            height: 100vh;
            background-color: grey;
        }
        #popcorn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease; /* Smooth transition for hover */
        }
        #popcorn:hover {
            content: url('popcorn (2).png'); /* Change image on hover */
        }
        .popcorn-piece {
            position: absolute;
            pointer-events: none;
            z-index: 20;
        }
    </style>
</head>
<body>
    <img id="popcorn" src="popcorn sad.png" alt="Popcorn Bucket" width="100">

    <script>
        // Module aliases
        const Engine = Matter.Engine,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events; // Add Events for collision detection

        // Create engine
        const engine = Engine.create();
        engine.world.gravity.y = 0.7; //gravity

        // Array to store popcorn pieces (sparkles)
        let popcornPieces = [];
        const popcornBucket = document.getElementById('popcorn');
        let music = new Audio('popcorn.mp3');
        let hoverSound = new Audio('swishes1n.mp3');  // Sound when mouse enters
        let hoverOffSound = new Audio('swishes2n.mp3');  // Sound when mouse leaves

        hoverSound.load();
        hoverOffSound.load();

        // Add ground physics for popcorn bucket
        const bucketRect = popcornBucket.getBoundingClientRect();
        const bucketWidth = bucketRect.width;
        const bucketTopX = bucketRect.left + bucketWidth / 2; // Center of bucket
        const bucketTopY = bucketRect.top; // Top edge of bucket

        // Create a static ground body at the top of the popcorn bucket
        const bucketGround = Bodies.rectangle(
            bucketTopX,           // x position (center of bucket)
            bucketTopY,           // y position (top of bucket)
            bucketWidth,          // width (matches bucket width)
            10,                  // height
            { isStatic: true }    // Static so it doesn't move
        );

        // Add the ground to the Matter.js world
        Composite.add(engine.world, bucketGround);

        // Function to create popcorn pieces (sparkles) with Matter.js physics
        function createPopcornSparkles(x, y) {
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2;
                const magnitude = Math.random() * 5 + 5; // Random speed 
                const body = Bodies.circle(x, y, 10, { 
                    restitution: 0.5, // Bounciness
                    friction: 0.1,
                    render: { visible: false }
                });
                Matter.Body.setVelocity(body, {
                    x: Math.cos(angle) * magnitude,
                    y: Math.sin(angle) * magnitude - 13 // Slight upward push
                });

                const piece = document.createElement('img');
                piece.src = 'popcornpr.png';
                piece.className = 'popcorn-piece';
                piece.style.width = '20px';
                piece.style.height = '20px';
                document.body.appendChild(piece);

                popcornPieces.push({ body, element: piece, alpha: 255 });
                Composite.add(engine.world, body);
            }
        }

        // Update positions of popcorn pieces and apply gravity
        function updatePopcornSparkles() {
            for (let i = popcornPieces.length - 1; i >= 0; i--) {
                const piece = popcornPieces[i];
                const pos = piece.body.position;

                piece.element.style.left = `${pos.x - 10}px`;
                piece.element.style.top = `${pos.y - 10}px`;
                piece.element.style.transform = `rotate(${piece.body.angle}rad)`;

                piece.alpha -= 1;
                piece.element.style.opacity = piece.alpha / 35; //original 255

                if (piece.alpha <= 0 || pos.y > window.innerHeight + 20) {
                    document.body.removeChild(piece.element);
                    Composite.remove(engine.world, piece.body);
                    popcornPieces.splice(i, 1);
                }
            }
        }

        // Click event on popcorn bucket (no image change here anymore)
        let popcornTimeout;

        popcornBucket.addEventListener('click', (e) => {
            const rect = popcornBucket.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top -10;
            
            createPopcornSparkles(x, y);
            music.play();
        });

        // Add hover event listeners
        popcornBucket.addEventListener('mouseenter', () => {
            hoverSound.currentTime = 0; // Reset to start
            hoverSound.play();
        });

        popcornBucket.addEventListener('mouseleave', () => {
            hoverOffSound.currentTime = 0; // Reset to start
            hoverOffSound.play();
        });

        // Collision detection for popcorn pieces hitting bucketGround
        Events.on(engine, 'collisionStart', (event) => {
            const pairs = event.pairs;

            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i];
                const bodyA = pair.bodyA;
                const bodyB = pair.bodyB;

                // Check if one body is bucketGround and the other is a popcorn piece
                if (bodyA === bucketGround || bodyB === bucketGround) {
                    const popcornBody = bodyA === bucketGround ? bodyB : bodyA;
                    // Verify it's a popcorn piece (circle with radius 10)
                    if (popcornBody.circleRadius === 10) {
                        // Clear any existing timeout
                        clearTimeout(popcornTimeout);
                        // Change to popcorn (3) on collision
                        popcornBucket.src = 'popcorn (3).png';
                        // Set timeout to revert back
                        popcornTimeout = setTimeout(() => {
                            popcornBucket.src = 'popcorn sad.png';
                        }, 1900);
                    }
                }
            }
        });

        // Animation loop
        function animate() {
            Engine.update(engine, 1000 / 60);
            updatePopcornSparkles();
            requestAnimationFrame(animate);
        }

        // Start the animation loop
        animate();
    </script>
</body>
</html>